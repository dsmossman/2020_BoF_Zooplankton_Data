{
    "collab_server" : "",
    "contents" : "# Master\n\n# setup -------------------------------------------------------------------\n\n# libraries\nlibrary(readxl)\nlibrary(oce)\nlibrary(ocedata)\nlibrary(marmap)\nlibrary(plyr)\nlibrary(R.utils)\nlibrary(ggplot2)\n\n# functions\nsourceDirectory('functions/', modifiedOnly = F)\n\n# set up project structure\nfunction_dir = 'functions/';  create_dir(function_dir)\ncache_dir = 'cache/';         create_dir(cache_dir)\ndata_dir = 'data/';           create_dir(data_dir)\nfigure_dir = 'figures/';      create_dir(figure_dir)\nreport_dir = 'reports/';       create_dir(report_dir)\n\n# get map data\nget_map_data(cache_dir)\n\n# process log file -----------------------------------------------------\n\n# ocean data log file\nlog_file = 'data/log.xlsx'\nlog_ofile = 'cache/log.rda'\n\nif(!file.exists(log_ofile)){\n  \n  # read in data\n  log = read_excel(log_file, sheet = 1)\n  comments = read_excel(log_file, sheet = 2)\n  \n  # copy for output\n  log_out = log\n  \n  # determine CTD station lat/lon\n  log$lat = ddm2dd(log$lat)\n  log$lon = -ddm2dd(log$lon)\n  \n  # add timestamp\n  log$datetime = as.POSIXct(paste0(log$date, ' ', log$time), format = \"%d-%b-%Y %H:%M\")\n  log$date = as.Date(log$date, format = '%d-%b-%Y')\n  \n  # fix column types\n  # factors\n  # log$sticker_id = as.factor(log$sticker_id)\n  # log$station = as.factor(log$station)\n  # log$type = as.factor(log$type)\n  # log$whales = as.factor(log$whales)\n  # numeric\n  log$depth_bottom_snd = as.numeric(log$depth_bottom_snd)\n  log$depth_bottom_ctd = as.numeric(log$depth_bottom_ctd)\n  log$depth_net_ctd = as.numeric(log$depth_net_ctd)\n  log$flow_start = as.numeric(log$flow_start)\n  log$flow_stop = as.numeric(log$flow_stop)\n  # logical\n  # log$cryo_sample = as.logical(log$cryo_sample)\n  # log$zoop_sample = as.logical(log$zoop_sample)\n  \n  # compute volume filtered from flow meter [see pg 5-6 in docs/flow_meter_manual.pdf for instructions]\n  r = 26873                                   # rotor constant\n  d = 0.75                                    # net diameter (m)\n  diff = log$flow_stop-log$flow_start         # difference (counts)\n  dist = (diff * r) / 999999                  # distance traveled (m)\n  log$vol_flow = (pi * d^2 * dist) / 4        # volume filtered (m^3)\n  \n  # estimate minimum volume filtered from net depth [based on volume of a cylinder of height = water depth]\n  log$vol_depth = pi*((d/2)^2)*log$depth_net_ctd  # volume filtered (m^3)\n  \n  # compare\n  plot(log$vol_depth, log$vol_flow)\n  \n  # save\n  save(log, file = log_ofile)\n  message('Log file saved as: ', log_ofile)\n  \n} else {\n  message('Loading log file from: ', log_ofile)\n  load(log_ofile)\n}\n\n# process ctd -------------------------------------------------------------\n\n# ctd data directory\nctd_dir = paste0(data_dir,'ctd/')\n\n# ctd output file\nctd_ofile = paste0(cache_dir, 'ctd.rda')\n\nif (!file.exists(ctd_ofile)) {\n  \n  # raw files\n  ctd_files = list.files(ctd_dir, pattern = '*_final.cnv')\n  \n  # metadata\n  ship = 'Shelagh'\n  cruise = 'GSL2017'\n  scientist = 'Hansen Johnson'\n  institute = 'Dalhousie University / Canadian Whale Institute'\n  \n  CTD = list()\n  for(i in seq_along(ctd_files)){\n    \n    # read data\n    ctd = read.ctd.sbe(paste0(ctd_dir,ctd_files[i]), debug = F, monitor = F)\n    \n    # extract pressure\n    pressure = ctd[['data']]$pressure\n    \n    # extract and convert time\n    time = as.POSIXct(ctd[['data']]$time, origin = \"2000-01-01 00:00\", tz = \"ADT\") # I'm not sure why this is UTC, but this must be correct because it aligns with my notes and the system start time\n    \n    # time check\n    time[1] == ctd[['metadata']]$startTime\n    \n    ctd[['time']] = time\n    \n    # extract station ID\n    s = unlist(strsplit(ctd_files[i], split = '_'))\n    id = s[2]\n    \n    ctd[['latitude']] = log$lat[which(log$id == paste0('CTD', id))]\n    ctd[['longitude']] = log$lon[which(log$id == paste0('CTD', id))]\n    \n    # define cruise and ship\n    ctd[['cruise']] = cruise\n    ctd[['ship']] = ship\n    ctd[['scientist']] = scientist\n    ctd[['institute']] = institute\n    \n    # add to list\n    CTD[[i]] = ctd\n  }\n  \n  # save\n  save(CTD, file = ctd_ofile)\n  message('CTD data saved as: ', ctd_ofile)\n}else{\n  message('Loading CTD data from: ', ctd_ofile)\n  load(ctd_ofile)\n}\n\n# process net data --------------------------------------------------------\n\n# net data directory\nnet_dir = paste0(data_dir,'net/')\n\n# net output file\nnet_ofile = paste0(cache_dir, 'net.rda')\n\n# if (!file.exists(net_ofile)) {\n\n# read in data\nn1 = read_excel(paste0(net_dir,'leg_1.xlsx'), sheet = 1) # leg 1\nn2 = read_excel(paste0(net_dir,'leg_2.xlsx'), sheet = 1) # leg 2\n\n# make column names equivalent\nn1$SEX = NA\nn2$ANALYSIS = NA\n\n# check equivalence\nif(FALSE %in% (names(n1) %in% names(n2))){\n  warning('DATA FRAMES NOT EQUIVALENT')\n}\n\n# join leg 1 and 2 datasets\nnet = rbind.data.frame(n1,n2)\n\n# convert/assign column variable types\nnet$SAMPLEID = as.factor(net$SAMPLEID)\nnet$TAXA = as.factor(net$TAXA)\n\n# remove and replace text in data value column\nnet$DATA_VALUE = gsub(pattern = 'N/A', replacement = NA, x = net$DATA_VALUE)\nnet$DATA_VALUE = gsub(pattern = 'too much sediment', replacement = NA, x = net$DATA_VALUE)\nnet$DATA_VALUE = as.numeric(net$DATA_VALUE)\n\n# remove and replace text in stage column\nnet$STAGE = gsub(pattern = 'C', replacement = '', x = net$STAGE)\nnet$SEX[grep(pattern = ' female', x = net$STAGE)] = 'female'\nnet$SEX[grep(pattern = ' male', x = net$STAGE)] = 'male'\nnet$STAGE = gsub(pattern = 'female', replacement = '', x = net$STAGE)\nnet$STAGE = gsub(pattern = 'male', replacement = '', x = net$STAGE)\nnet$STAGE = trimws(net$STAGE)\n\n# fix euphasiid names\nnet$TAXA = gsub(pattern = 'Euphausidae', replacement = 'Euphausiidae', x = net$TAXA)\nnet$TAXA = gsub(pattern = 'Euphausiid', replacement = 'Euphausiidae', x = net$TAXA)\nnet$TAXA = gsub(pattern = 'Euphausiidaeae', replacement = 'Euphausiidae', x = net$TAXA)\n\n# fix evande names\nnet$TAXA = gsub(pattern = 'Evadne nordmanni', replacement = 'Evadne nordmanii', x = net$TAXA)\n\n\n# rectify capitals\nnet$WHAT_WAS_IT = toupper(net$WHAT_WAS_IT)\nnet$BUG_SIZE = toupper(net$BUG_SIZE)\n\n# add column for volume filtered\nnet$VOL = NA\nnet$WHALE = NA\n\n# loop through and associate each sample with log info\nfor(i in 1:nrow(log)){\n  # station\n  net$STN[which(as.character(net$SAMPLEID) == as.character(log$sticker_id[i]))] = log$station[i]\n  # depth\n  net$DEPTH[which(as.character(net$SAMPLEID) == as.character(log$sticker_id[i]))] = log$type[i]\n  # volume filtered\n  net$VOL[which(as.character(net$SAMPLEID) == as.character(log$sticker_id[i]))] = log$vol_depth[i]\n  # whale presence\n  net$WHALE[which(as.character(net$SAMPLEID) == as.character(log$sticker_id[i]))] = log$whales[i]\n}\n\n# calculate concentration \nnet$CONC = net$DATA_VALUE / net$SPLIT_FRACTION / net$VOL\nnet$RAW_COUNT = net$DATA_VALUE / net$SPLIT_FRACTION\n\n#   # save\n#   save(net, file = net_ofile)\n#   message('Net data saved as: ', net_ofile)\n# }else{\n#   message('Loading net data from: ', net_ofile)\n#   load(net_ofile)\n# }\n\n# plot biomass by station -------------------------------------------------\n\n# make output directory\noutdir = paste0(figure_dir,'biomass/'); create_dir(outdir)\n\n# make a subset for plotting\nbio = subset(net, net$WHAT_WAS_IT == 'WEIGHT' & net$BUG_SIZE == 'MESO+MACRO' & net$DEPTH == 'FULL')\nbio = droplevels(bio)\n\n# set ylim\nylim_bio = range(bio$CONC)\n\n# plot data\nggplot(data = bio, aes(x = STN, y = RAW_COUNT))+\n  geom_bar(stat=\"identity\", aes(fill = WHALE), color = 'black', na.rm = T)+\n  scale_fill_manual(values=c(\"white\", \"gray\", \"darkslategray\"))+\n  theme_bw()+\n  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))\n\nggsave(filename = paste0(outdir, 'biomass.png'))\n\n# plot counts by station ----------------------------------------------\n\n# make output directory\noutdir = paste0(figure_dir,'counts/'); create_dir(outdir)\n\n# make a subset for plotting\ncts = subset(net, net$WHAT_WAS_IT == 'COUNT' & net$DEPTH == 'FULL')\ncts = droplevels(cts)\ncts$STN = as.factor(cts$STN)\n\n# set ylim\nylim_cts = range(cts$RAW_COUNT)\n\nnts = list()\n\n# loop through and generate plot for each station\nfor(i in seq_along(levels(cts$STN))){\n  \n  # define station\n  stn = levels(cts$STN)[i]\n  \n  # define output file\n  fout = paste0(outdir, stn, '_counts.png')\n  \n  message('Plotting raw counts for sample ', stn, ' and saving it as: ', fout)\n  \n  # open plot\n  png(filename = fout, width = 7, height = 5, units = 'in', res = 200)\n  \n  # set margins for plotting\n  par(mar = c(10,4,4,2))\n  \n  # subset for plotting\n  tmp = subset(cts, cts$STN == stn)\n  nts[[paste0(stn)]] = subset(cts, cts$STN == stn)\n  \n  # make plot\n  plot(tmp$RAW_COUNT~tmp$TAXA, \n       las = 2, xlab = '', ylab = 'counts per m^2', \n       ylim = ylim_cts, cex.axis = 0.5, main = paste0('Station: ', stn, ' (Sample ID: ', tmp$STN[1], ', Sticker ID: ', tmp$SAMPLEID[1], ')'))\n  \n  # close plot\n  dev.off()\n}\n\n# plot target species -----------------------------------------------------\n\n# make output directory\noutdir = paste0(figure_dir,'target_species/'); create_dir(outdir)\n\n### FINMARCHICUS ###\n\n# make a subset for plotting\nspp = subset(net, net$TAXA == 'Calanus finmarchicus' & net$DEPTH == 'FULL')\nspp = droplevels(spp)\n\n# plot data\nggplot(data = spp, aes(x = STN, y = RAW_COUNT))+\n  geom_bar(stat=\"identity\", aes(fill = STAGE), color = 'black', na.rm = T)+\n  scale_fill_manual(values=rev(oceColorsViridis(6)))+\n  theme_bw()+\n  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))\n\nggsave(filename = paste0(outdir, 'calanus_finmarchicus.png'))\n\n### HYPERBOREUS ###\n\n# make a subset for plotting\nspp = subset(net, net$TAXA == 'Calanus hyperboreus' & net$DEPTH == 'FULL')\nspp = droplevels(spp)\n\n# plot data\nggplot(data = spp, aes(x = STN, y = RAW_COUNT))+\n  geom_bar(stat=\"identity\", aes(fill = STAGE), color = 'black', na.rm = T)+\n  scale_fill_manual(values=rev(oceColorsViridis(4)))+\n  theme_bw()+\n  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))\n\nggsave(filename = paste0(outdir, 'calanus_hyperboreus.png'))\n\n### HYPERBOREUS ###\n\n# make a subset for plotting\nspp = subset(net, net$TAXA == 'Calanus hyperboreus' & net$DEPTH == 'FULL')\nspp = droplevels(spp)\n\n# plot data\nggplot(data = spp, aes(x = STN, y = RAW_COUNT))+\n  geom_bar(stat=\"identity\", aes(fill = STAGE), color = 'black', na.rm = T)+\n  scale_fill_manual(values=rev(oceColorsViridis(4)))+\n  theme_bw()+\n  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))\n\nggsave(filename = paste0(outdir, 'calanus_hyperboreus.png'))\n\n### GLACIALIS ###\n\n# make a subset for plotting\nspp = subset(net, net$TAXA == 'Calanus glacialis' & net$DEPTH == 'FULL')\nspp = droplevels(spp)\n\n# plot data\nggplot(data = spp, aes(x = STN, y = RAW_COUNT))+\n  geom_bar(stat=\"identity\", aes(fill = STAGE), color = 'black', na.rm = T)+\n  scale_fill_manual(values=rev(oceColorsViridis(2)))+\n  theme_bw()+\n  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))\n\nggsave(filename = paste0(outdir, 'calanus_glacialis.png'))\n\n### ALL CALANUS ###\n\n# target taxa\ntaxa_list = c('Calanus finmarchicus', \n              'Calanus glacialis', \n              \"Calanus hyperboreus\")\n\n# make a subset for plotting\nspp = subset(net, net$DEPTH == 'FULL')\nspp = spp[spp$TAXA %in% taxa_list,]\nspp = droplevels(spp)\n\n# plot data\nggplot(data = spp, aes(x = STN, y = RAW_COUNT))+\n  geom_bar(stat=\"identity\", aes(fill = STAGE), color = 'black', na.rm = T)+\n  scale_fill_manual(values=rev(oceColorsViridis(6)))+\n  facet_wrap(~TAXA, nrow = 1)+\n  theme_bw()+\n  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5, size = 6))\n\nggsave(filename = paste0(outdir, 'calanus.png'))\n\n### TARGET ###\n\n# target taxa\ntaxa_list = c('Calanus finmarchicus', \n              'Calanus glacialis', \n              \"Calanus hyperboreus\", \n              \"Oithona similis\",\n              \"Oithona atlantica\",\n              \"Temora longicornis\",\n              \"Pseudocalanus sp\",\n              \"Evadne nordmanii\",\n              \"Euphausiidae\")\n\n# make a subset for plotting\nspp = subset(net, net$DEPTH == 'FULL')\nspp = spp[spp$TAXA %in% taxa_list,]\n\n# remove other stages\nspp$STAGE[!spp$STAGE %in% c('I', 'II', 'III', 'IV', 'V', 'VI')] = NA\n\n# convert whale maybe/absent to absent\nspp$WHALE[spp$WHALE=='maybe'] ='absent'\n\n# remove unused levels\nspp = droplevels(spp)\n\n# plot data\nggplot(data = spp, aes(x = STN, y = RAW_COUNT))+\n  geom_bar(stat=\"identity\", aes(fill = STAGE, color = WHALE), size = 0.5, na.rm = T)+\n  scale_color_manual(values=c(NA, 'red'))+\n  scale_fill_manual(values=rev(oceColorsViridis(6)), na.value = 'grey')+\n  facet_wrap(~TAXA, nrow = 3)+\n  theme_bw()+\n  xlab('STATION')+\n  ylab('RAW COUNTS')+\n  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5, size = 6))\n\nggsave(filename = paste0(outdir, 'target_species.png'))\n\n# plot station map --------------------------------------------------------\n\n# read in map data\nload('cache/map.rda')\n\n# plotting dimensions\nmlon = mean(log$lon)\nmlat = mean(log$lat)\nspan = 275\n\npng('figures/station_map.png', width = 7, height = 6, units = 'in', res = 250)\n\n# plot coastline\nplot(coastlineWorldFine, clon = mlon, clat = mlat, span = span)\n\n# plot bathymetry\ncontour(bathyLon,bathyLat,bathyZ,levels = c(-50, -100, -150, -200, -250),lwd = c(1, 1, 2, 2, 3),lty = c(3, 1, 3, 1, 3),drawlabels = F,add = TRUE,col = 'darkgray')\n\n# add depth legend\nlegend(\"bottomright\",lwd = c(1, 1, 2, 2, 3),lty = c(3, 1, 3, 1, 3),col = 'darkgray',seg.len = 3,cex = 0.8,title = \"Depth [m]\",legend = c(\"50\", \"100\", \"150\", \"200\", \"250\"),bg= \"white\")\n\n#### add data ####\nwith(subset(log, log$type=='FULL' & log$whales == 'present'), points(lon, lat, pch=21, bg = 'red'))\nwith(subset(log, log$type=='FULL' & log$whales != 'present'), points(lon, lat, pch=21, bg = 'blue'))\nwith(subset(log, log$type=='FULL'), text(lon, lat, labels = 1:16, pos = c(2,4), cex = 0.7, col = 'darkslategrey'))\n\nlegend('bottomleft', pch = c(21,21), pt.bg = c('red', 'blue'), legend = c('Present', 'Absent'), title = 'Right whales', cex = 1)\n# title('Sampling locations')\n\ndev.off()",
    "created" : 1510871545024.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "535711175",
    "id" : "7288DD34",
    "lastKnownWriteTime" : 1513548717,
    "last_content_update" : 1513548717774,
    "path" : "~/Projects/gsl_habitat/master.R",
    "project_path" : "master.R",
    "properties" : {
        "docOutlineVisible" : "1",
        "tempName" : "Untitled1"
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}